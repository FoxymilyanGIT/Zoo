import { Link } from "react-router-dom";

// Парсинг imageUrls из строки (JSON) в массив
const parseImageUrls = (imageUrls) => {
  if (!imageUrls) return [];
  try {
    return JSON.parse(imageUrls);
  } catch {
    return Array.isArray(imageUrls) ? imageUrls : [];
  }
};

// Преобразование относительного URL в абсолютный для загруженных изображений
const getImageUrl = (url) => {
  if (!url) return "https://placehold.co/400x250";
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }
  if (url.startsWith("/uploads/")) {
    const baseURL = import.meta.env.VITE_API_BASE_URL || "http://localhost:8080";
    return baseURL + url;
  }
  return url;
};

export const AnimalCard = ({ animal }) => {
  const images = parseImageUrls(animal.imageUrls);
  return (
    <div className="card p-0 flex flex-col overflow-hidden group animate-fade-in" data-testid="animal-card">
      <div className="relative overflow-hidden">
        <img
          src={getImageUrl(images[0])}
          alt={animal.name}
          className="h-56 w-full object-cover transition-transform duration-500 group-hover:scale-110"
          onError={(e) => {
            e.target.src = "https://placehold.co/400x250";
          }}
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        <div className="absolute bottom-2 left-2 right-2">
          <span className="inline-block px-2 py-1 bg-brand-600/90 backdrop-blur-sm text-white text-xs font-semibold rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            {animal.zone}
          </span>
        </div>
      </div>
      <div className="p-4 flex flex-col flex-1">
        <h3 className="text-xl font-bold text-slate-800 mb-1 group-hover:text-brand-700 transition-colors duration-200">
          {animal.name}
        </h3>
        <p className="text-sm text-slate-600 mb-2 italic">{animal.species}</p>
        <p className="text-xs text-slate-500 mb-4 flex items-center gap-1">
          <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
          {animal.status === "active" ? "Доступно для посещения" : "На отдыхе"}
        </p>
        <Link
          to={`/animals/${animal.id}`}
          className="mt-auto inline-flex items-center gap-2 text-brand-700 font-semibold hover:text-brand-800 group/link transition-all duration-200"
        >
          Подробнее
          <span className="transform group-hover/link:translate-x-1 transition-transform duration-200">→</span>
        </Link>
      </div>
    </div>
  );
};
